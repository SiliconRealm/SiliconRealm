# Silicon Realm 架构设计文档

**Version:** 3.0  
**Date:** 2026-02-02  
**Status:** Approved for Implementation

---

## 目录

1. [执行摘要](#1-执行摘要)
2. [架构全景](#2-架构全景)
3. [核心哲学](#3-核心哲学)
4. [核心组件](#4-核心组件)
5. [通信机制](#5-通信机制)
6. [领域演进](#6-领域演进)
7. [关键业务流](#7-关键业务流)
8. [实施策略](#8-实施策略)
9. [风险缓解](#9-风险缓解)
10. [总结](#10-总结)

---

## 1. 执行摘要

### 1.1 核心愿景

Silicon Realm 是一个 **"数字生命体组织"** 平台，超越传统 IDE "人使用工具"的范畴，进化为 **"人管理虚拟员工"** 的协作平台。

系统通过拟人化的 **King (规划者)**、**Lord (管理者)**、**Knight (执行者)** 分层架构，结合 **Roundtable (圆桌会议)** 协同机制和 **Canal (运河)** 基础设施层，实现业务的自动拆解、执行与自我治理。

### 1.2 设计原则

| 原则 | 描述 |
|:-----|:-----|
| 君主立宪制 | AI 拥有自治权，但架构变更与关键决策需人类批准 |
| 精英治理 | 圆桌会议仅限 Lord 参与，确保决策高效 |
| 双层会话 | 守护会话常驻响应 + Topic 会话按需启动 |
| 主动协同 | AI 可通过合规渠道主动触达人类（吹哨人机制） |
| 三层决策 | AI 自治 → 圆桌共识 → 人类终审 |
| 身份即目录 | Agent 本质是"配置化上下文" + "标准化执行引擎" |

---

## 2. 架构全景

### 2.1 系统拓扑

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Human Plane (内阁)                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  ┌──────────┐            │
│  │ CXO/Admin│  │ 领域专家  │  │ 治理仪表盘   │  │ Slack/IM │            │
│  └──────────┘  └──────────┘  └──────────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Orchestration Plane (编排层)                        │
│                                                                         │
│                         ┌──────────────────┐                            │
│                         │    🚢 Canal      │                            │
│                         │    (运河引擎)     │                            │
│                         └────────┬─────────┘                            │
│                                  │                                      │
│    ┌─────────────┬───────────────┼───────────────┬─────────────┐       │
│    ▼             ▼               ▼               ▼             ▼       │
│ ┌───────┐  ┌──────────┐  ┌────────────┐  ┌──────────┐  ┌──────────┐   │
│ │容器管理│  │ 消息路由 │  │  沙箱编排   │  │ 资源管控 │  │ 健康监控 │   │
│ └───────┘  └──────────┘  └────────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                ┌───────────────────┴───────────────────┐
                ▼                                       ▼
┌───────────────────────┐          ┌─────────────────────────────────────┐
│  Governance (王冠)    │          │         Domain Plane (领地)         │
│                       │          │                                     │
│ ┌───────────────────┐ │          │ ┌─────────┐      ┌─────────┐       │
│ │     👑 King       │ │          │ │🏰Lord A │      │🏰Lord B │       │
│ │    (核心领域)      │ │          │ │(Finance)│ ... │ (Tech)  │       │
│ └───────────────────┘ │          │ └─────────┘      └─────────┘       │
│ ┌───────────────────┐ │          │         │              │           │
│ │  📕 通讯录        │ │          │         └──────┬───────┘           │
│ │   (GraphDB)       │ │          │                ▼                   │
│ └───────────────────┘ │          │        ┌─────────────┐             │
│ ┌───────────────────┐ │          │        │  ⚔️ Knights │             │
│ │  🛡️ 策略引擎      │ │          │        │  (沙箱执行)  │             │
│ └───────────────────┘ │          │        └─────────────┘             │
└───────────────────────┘          └─────────────────────────────────────┘
                                                    │
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┼ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
                  协作机制 (按需触发)                │
│                                                   ▼                   │
  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│ │              ⚖️ 圆桌会议 (Roundtable)                           │  │
    • 触发：领域争议、资源申请、架构变更
│ │ • 参与：King + 相关 Lords                                       │  │
    • 流程：议程 → 发言 → 投票 → 人类终审
│ │ • 产出：决议 (Resolution)                                       │  │
  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                        Infrastructure (基础设施)                         │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│  │ ⚡ Redis     │  │ 🧠 Qdrant    │  │ 📦 JuiceFS   │  │ 🐳 K8s/Kata│  │
│  │  Streams    │  │  VectorDB   │  │   Storage    │  │  Containers│  │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                        Knowledge Plane (学院)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │ 📚 知识库    │  │ 🛠️ 技能库    │  │ 🔧 工具注册表│                  │
│  │ (SOP/案例)   │  │(Prompt模板)  │  │  (MCP工具)   │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 层级职责

| 层级 | 职责 | 核心组件 |
|:-----|:-----|:---------|
| Human Plane | 人类监督与决策终审 | Dashboard, IM 通知 |
| Orchestration Plane | 全局编排与生命周期管理 | Canal (运河) |
| Governance Plane | 组织治理与跨域协调 | King, 通讯录, 策略引擎 |
| Domain Plane | 业务领域执行 | Lords, Knights |
| Infrastructure | 底层能力支撑 | Redis, Qdrant, JuiceFS, K8s |
| Knowledge Plane | 知识沉淀与共享 | 知识库, 技能库, 工具注册表 |

---

## 3. 核心哲学

### 3.1 身份即目录 (Identity-as-Context)

每个 Agent 都不是独立程序，而是一个 **特定的文件目录**：

```
Agent = DNA 层 (Files) + 引擎层 (Engine)

┌─────────────────────────────────────────────────────────────┐
│  DNA 层 (身份与约束)          │  引擎层 (统一执行能力)       │
│  ├── soul.md    (人格风格)    │  ├── Claude Code CLI        │
│  ├── agent.md   (职责/SOP)    │  ├── OpenHands              │
│  ├── rules.md   (合规约束)    │  └── Custom CLI             │
│  └── tools/     (MCP工具)     │                             │
└─────────────────────────────────────────────────────────────┘
```

**核心优势**：
- 创建新 Agent 只需创建文件夹，无需写代码
- 整个王国运行史就是 Git Commit History
- 任何 K8s 节点都能瞬间拉起任何 Agent

### 3.2 同构架构 (Isomorphic Architecture)

King 和 Lord 本质上是 **同构的**，都基于双层会话模型，都可派发 Knight。区别仅在于 **领域职责** 和 **文件系统视野**：

| 角色 | DDD 定位 | 领域职责 | 文件系统视野 |
|:-----|:---------|:---------|:-------------|
| King | 核心领域 | 组织治理、领域划分、资源调度、跨域协调 | `agents/` (全局) |
| Lord | 业务领域 | 任务规划、任务执行、业务处理、知识沉淀 | `agents/{domain}/` |
| Knight | 执行单元 | 原子任务执行，运行在沙箱中 | 当前任务目录 (极窄) |

### 3.3 双层会话模型

```
┌─────────────────────────────────────────────────────────────┐
│                    守护会话 (Daemon Session)                 │
│  • 常驻运行，保持 Agent 在线状态                            │
│  • 监听 inbox，接收新消息                                   │
│  • 快速响应，路由决策                                       │
│  • Heartbeat 保活（每 30 分钟 ping）                        │
└─────────────────────────┬───────────────────────────────────┘
                          │ 派生
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Topic 会话 (Topic Sessions)               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │ Topic A │  │ Topic B │  │ Topic C │  ...                │
│  │ 用户认证 │  │ 数据迁移 │  │ Bug修复  │                     │
│  └─────────┘  └─────────┘  └─────────┘                     │
│  • 按需启动，任务完成后可休眠                               │
│  • 上下文隔离，避免信息污染                                 │
│  • 可并行处理多个不相关任务                                 │
└─────────────────────────────────────────────────────────────┘
```

**会话路由决策**：

| 消息类型 | 处理方式 | 示例 |
|:---------|:---------|:-----|
| 简单查询 | 守护会话直接处理 | "当前有多少待办任务？" |
| 新任务 | 创建新 Topic 会话 | "设计用户认证模块" |
| 已有任务跟进 | 路由到对应 Topic | "认证模块的进展如何？" |
| 紧急事项 | 中断当前 Topic，优先处理 | "生产环境出现故障" |

### 3.4 记忆压缩机制

Topic 会话休眠时执行 **记忆压缩 (Memory Consolidation)**：

```
Phase 1: 短期记忆摘要
  └─ 提取关键决策、重要发现、待办事项 → summary.json

Phase 2: 长期记忆归档
  └─ 向量化存入 VectorDB (Qdrant)，更新 memory/index.json

Phase 3: 状态持久化
  └─ git commit，保留 Topic 会话文件，释放内存资源
```

**记忆分层**：

| 层级 | 存储位置 | 内容 | 生命周期 |
|:-----|:---------|:-----|:---------|
| 工作记忆 | Topic 会话内存 | 当前对话完整上下文 | 会话休眠后释放 |
| 短期记忆 | `sessions/topics/*.jsonl` | Topic 会话完整记录 | Topic 完成后归档 |
| 长期记忆 | VectorDB + `memory/archive/` | 重要决策、经验教训 | 永久保留 |

---

## 4. 核心组件

### 4.1 治理层与基础设施

#### 最小化系统的核心

**King + Canal 构成 Silicon Realm 的最小可运行系统**。King 是决策中枢，Canal 是连接一切、运输资源的基础设施。即使没有任何 Lord，这个最小系统也能独立运作。Lord 只是随着业务复杂度增长，从 King 的职责中拆分出来的业务领域。

```
┌─────────────────────────────────────────────────────────────┐
│                    最小化系统 (Minimal System)               │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              👑 King + 🚢 Canal                      │   │
│   │                                                     │   │
│   │   King (决策者)              Canal (运河)           │   │
│   │   • 思考与决策               • 容器编排             │   │
│   │   • 意志与方向               • 消息路由             │   │
│   │   • 战略规划                 • 资源调度             │   │
│   │                                                     │   │
│   │   如同大脑                   如同运河               │   │
│   │   决定"做什么"              连接各地、运输资源     │   │
│   └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                    业务复杂度增长                           │
│                              ▼                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              🏰 Lords (业务领域分化)                 │   │
│   │                                                     │   │
│   │   从 King 的职责中拆分出独立的业务领域              │   │
│   │   Lord 与 King 同构，但专注于特定业务               │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.1 King (国王)

King 是 **核心领域 (Core Domain)** 的 Agent，是王国的决策中枢。

| 属性 | 描述 |
|:-----|:-----|
| 本体 | 高级 LLM (Claude 3.5 Sonnet / O1) |
| 隐喻 | 王国的决策中枢 |
| 架构 | 守护会话 + Topic 会话 + Knight 派发能力 |
| 运行模式 | 常驻容器 |
| 文件视野 | `agents/` (全局视野) |

**核心职能**：

| 职能 | 描述 |
|:-----|:-----|
| 战略决策 | 制定组织目标，规划发展方向 |
| 消息路由 | 将用户请求路由到合适的 Lord（或自己处理） |
| 领域管理 | 创建/拆分/合并业务领域 |
| 资源调度 | 分配 Knight 配额，管理系统资源 |
| 跨域协调 | 主持圆桌会议，仲裁领域争议 |
| 系统演进 | 提出架构变更提案（需人类批准） |

#### 4.1.2 Canal (运河)

Canal 是王国的基础设施层，如同运河连接各地、运输资源。它不是一个"角色"，而是让一切成为可能的底层能力。

| 属性 | 描述 |
|:-----|:-----|
| 本体 | 高性能系统服务（Go / Rust / Python） |
| 隐喻 | 运河、水道、基础设施 |
| 形态 | 极低延迟的常驻守护进程 |
| 设计原则 | 高可用、低延迟、无状态 |

**核心职能**：

| 职能 | 描述 |
|:-----|:-----|
| 容器生命周期 | 启动、停止、重启所有 Agent 容器 |
| 消息路由 | 监听 Redis Streams，分发消息 |
| 沙箱编排 | 为 Knight 创建隔离的沙箱环境 |
| 资源管控 | 执行配额限制，超支熔断 |
| 记忆索引 | 将会话摘要向量化存入 Qdrant |
| 健康监控 | 监控所有 Agent 健康状态 |

#### 4.1.3 King 与 Canal 的关系

```
┌─────────────────────────────────────────────────────────────┐
│                King + Canal = 最小系统                       │
│                                                             │
│   👑 King (决策者)              🚢 Canal (运河)             │
│   ├── 思考：我要做什么？        ├── 容器：谁需要启动？      │
│   ├── 决策：应该怎么做？        ├── 路由：消息送往何处？    │
│   ├── 规划：未来走向哪？        ├── 沙箱：如何安全执行？    │
│   └── 治理：组织如何运作？      └── 监控：系统是否健康？    │
│                                                             │
│   King 没有 Canal：有想法但无法落地                         │
│   Canal 没有 King：有能力但不知为谁服务                     │
│                                                             │
│   King 是决策者，Canal 是让决策成为现实的基础设施           │
└─────────────────────────────────────────────────────────────┘
```

#### 4.1.4 统一通讯录 (Address Book)

| 属性 | 描述 |
|:-----|:-----|
| 技术 | 图数据库 (GraphDB) |
| 内容 | 存储所有 Agent 和 Human 的节点 |
| 关系 | REPORTS_TO, DEPENDS_ON, CAN_CONTACT 等边 |

### 4.2 领域层：Lords (领主)

Lord 是从 King 的职责中拆分出来的 **业务领域 Agent**。当业务复杂度增长，King 无法独自处理所有事务时，便将特定业务领域委托给 Lord 管理。

**Lord 与 King 的关系**：
- Lord 与 King **同构**（相同的双层会话架构）
- Lord 是 King 的"分身"，专注于特定业务领域
- 在最小化系统中，King 可以独自处理所有业务，无需 Lord

```
┌─────────────────────────────────────────────────────────────┐
│                    Lord 的诞生                               │
│                                                             │
│   初始状态：King 处理所有业务                               │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  👑 King: 财务 + 技术 + 销售 + 人事 + ...           │   │
│   └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                    业务复杂度增长                           │
│                              ▼                              │
│   演进状态：拆分出专门的 Lord                               │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  👑 King: 核心治理 + 跨域协调                        │   │
│   │  🏰 Lord Finance: 财务领域                           │   │
│   │  🏰 Lord Tech: 技术领域                              │   │
│   │  🏰 Lord Sales: 销售领域                             │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**Lord 容器架构**：

```
┌─────────────────────────────────────────────────────────────┐
│                    Lord 容器架构                             │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              OpenClaw Gateway (常驻)                 │   │
│   │                                                     │   │
│   │  ┌─────────────────────────────────────────────┐   │   │
│   │  │         守护会话 (Daemon Session)            │   │   │
│   │  │  • 监听 inbox  • 消息路由  • Topic 管理     │   │   │
│   │  └─────────────────────────────────────────────┘   │   │
│   │           ┌─────────────┼─────────────┐             │   │
│   │           ▼             ▼             ▼             │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│   │  │  Topic A    │ │  Topic B    │ │  Topic C    │   │   │
│   │  │  (活跃)     │ │  (休眠)     │ │  (活跃)     │   │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   挂载卷:                                                   │
│   agents/{domain}/ → /app/workspace/                       │
│   agents/academy/ → /app/academy/ (只读)                   │
└─────────────────────────────────────────────────────────────┘
```

**唤醒触发源**：

| 触发方式 | 描述 |
|:---------|:-----|
| 用户直连 | 用户通过消息通道直接联系 Lord |
| King 路由 | King 将任务路由到对应 Lord |
| Lord 间通信 | 其他 Lord 发送协作请求 |
| 定时任务 | Cron 触发的定期任务 |

**领域边界原则** (基于 DDD)：

| 原则 | 描述 |
|:-----|:-----|
| 第一责任人 | 模糊地带由首次接手的 Lord 负责 |
| 明确转交 | Lord 可将任务转交，但必须显式声明 |
| 事后优化 | Lord 有权提出领域权责优化建议 |
| 业务导向 | 划分基于业务领域而非技术栈 |

### 4.3 协作机制：圆桌会议 (The Roundtable)

圆桌会议是一种**按需触发的协作仪式**，而非常驻的基础设施。当需要跨领域协调或集体决策时，由 King 或相关 Lord 发起召集。

| 属性 | 描述 |
|:-----|:-----|
| 本质 | 协作机制 / 仪式，非基础设施 |
| 触发条件 | 领域争议、资源申请、架构变更等需要集体决策的事项 |
| 参与者 | King + 相关 Lords |
| 生命周期 | 按需召集 → 议事 → 决议 → 散会 |

**会议流程 (MVP)**：

| 阶段 | 执行者 | 描述 |
|:-----|:-------|:-----|
| 1. 议程宣读 | Chairperson | 宣布议题列表、发言顺序 |
| 2. 轮流发言 | 发言 Lords | 按顺序进行 **3 轮** 轮流发言 |
| 3. 组织投票 | Chairperson | 组织 **非发言 Lord** 投票表决 |
| 4. 议题总结 | Chairperson | 汇总发言要点和投票结果 |
| 5. 人类终审 | Admin | 重大决策需人类最终确认 |
| 6. 下一议题 | Chairperson | 重复步骤 1-5 |

**死锁风险防控**：

| 策略 | 描述 |
|:-----|:-----|
| 信息熵检测 | 对话信息熵低于阈值时，立即停止当前议题 |
| 限流机制 | 限制 Lord 频繁交流的频率 |
| 精简输出 | 要求 Lord 只输出核心要点 |

### 4.4 执行层：Knights (骑士)

Knight 是运行在 **沙箱环境** 中的 **Subagent**，由 King 或 Lord 按需派发，执行原子任务。

| 属性 | 描述 |
|:-----|:-----|
| 本质 | 沙箱化的 Subagent |
| 运行环境 | Docker / Kata Containers |
| 生命周期 | 用完即毁，无持久记忆 |
| 能力 | 运行代码、CLI 工具、文件操作、爬虫 |
| 通信 | Stdio Tunnel 与父 Agent 实时交互 |

**Spec 驱动执行模式**：

```
┌─────────────────────────────────────────────────────────────┐
│                    父 Agent 规划阶段                         │
│  1. 接收任务/消息                                           │
│  2. 制定计划 (Plan)                                          │
│  3. 设计方案 (Design)                                        │
│  4. 拆解为任务清单 (Task List)                               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Knight 执行阶段                           │
│  1. 载入：任务描述 + 技能包 + 工具                           │
│  2. 执行：任务清单中的单个原子任务                           │
│  3. 交付：向父 Agent 提交执行产物                            │
│  ⚠️ 无需知道整体上下文，只关注当前原子任务                   │
└─────────────────────────────────────────────────────────────┘
```

**任务生命周期**：

| 阶段 | 描述 |
|:-----|:-----|
| 派发 | 父 Agent 创建 workshop 目录，写入 task.md |
| 启动 | Canal 启动 Knight 沙箱容器 |
| 执行 | Knight 在沙盒中执行任务 |
| 成功 | 交付产物给父 Agent（写入 output/ 目录） |
| 失败处理 | 上报父 Agent，由父 Agent 决定：继续/重试/跳过 |
| 升级 | 父 Agent 无法抉择时，询问用户或上级 |
| 销毁 | 任务完成后，沙箱容器自动销毁 |

**沙箱安全机制**：

| 机制 | 描述 |
|:-----|:-----|
| 文件系统隔离 | 只能访问当前 workshop 目录 |
| 网络限制 | 可配置的网络访问白名单 |
| 资源配额 | CPU、内存、执行时间限制 |
| 命令审批 | 危险命令需要审批或被拦截 |
| 只读挂载 | 父 Agent 的配置文件只读挂载 |

### 4.5 知识层：学院 (The Academy)

系统的"智慧图书馆"，用于共享和持久化高价值的组织知识。

| 属性 | 描述 |
|:-----|:-----|
| 定位 | 跨领域知识共享中心，所有 Lord 的共同资产 |
| 核心价值 | 避免重复造轮子，沉淀组织智慧 |
| 访问权限 | 所有 Lord 可读取，King 管理写入权限 |

**三大支柱**：

| 支柱 | 描述 | 内容类型 |
|:-----|:-----|:---------|
| Knowledge Base | 高价值领域知识、SOP、经验总结 | 文档、案例、最佳实践 |
| Skill Library | 可复用的 Agent 技能包 | Prompt 模板、推理策略 |
| Tool Registry | MCP 工具的标准化注册与发现 | 工具元数据、接口定义 |

**知识入库流程**：

```
Lord 发现可复用知识 → 提交入库申请 → King 审核 → Academy 持久化 → 人类终审(高价值内容)
```

**技术选型 (MVP)**：

| 组件 | 选型 | 理由 |
|:-----|:-----|:-----|
| 向量数据库 | Qdrant | 轻量级、易部署、性能优秀 |
| 知识存储 | Git 仓库 | 版本控制、协作友好、审计追溯 |
| 索引粒度 | 段落级 | 平衡检索精度和召回率 |

---

## 5. 通信机制

### 5.1 通信架构

```
┌─────────────────────────────────────────────────────────────┐
│                    异步消息层 (Redis Streams)                │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│   │ king:inbox  │    │lord:A:inbox │    │lord:B:inbox │    │
│   └─────────────┘    └─────────────┘    └─────────────┘    │
└─────────────────────────────────────────────────────────────┘
          │                  │                  │
     ┌────┴────┐        ┌────┴────┐        ┌────┴────┐
     │  King   │◄──────►│ Lord A  │◄──────►│ Lord B  │
     └─────────┘        └────┬────┘        └─────────┘
                             │ Sandbox (同步)
                             ▼
                        ┌─────────┐
                        │ Knight  │
                        └─────────┘
```

### 5.2 通信模式

| 通信路径 | 模式 | 技术 |
|:---------|:-----|:-----|
| King ↔ Lord | 异步消息 | Redis Streams (inbox/outbox) |
| Lord ↔ Lord | 异步消息 | Redis Streams (inbox/outbox) |
| Lord → Knight | 同步调用 | Sandbox 实时交互 (Stdio Tunnel) |

### 5.3 消息结构

```json
{
  "id": "msg_uuid",
  "from": "lord:finance",
  "to": "king",
  "type": "request_quota | motion | task_result | alert",
  "payload": { ... },
  "timestamp": "2026-02-01T10:00:00Z",
  "reply_to": "lord:finance:inbox"
}
```

### 5.4 人类接口

**策略引擎 (Policy Engine)**：

| 属性 | 描述 |
|:-----|:-----|
| 职责 | 防止 AI 骚扰人类 |
| 规则 | 基于严重等级、时间、频次进行过滤 |
| 示例 | "非 P0 级故障，禁止在 22:00-08:00 发送短信" |

**Deep Link (作战室链接)**：

当 AI 发送警报时，附带 URL。点击后直接进入 IDE 的特定 Session，上下文已包含错误现场，实现即时 Human-in-the-loop。

---

## 6. 领域演进

### 6.1 领域拆分

**触发条件**：Lord 认为自己的领域混杂了其他领域内容

| 阶段 | 执行者 | 描述 |
|:-----|:-------|:-----|
| 1 | Lord | 向 King 提议进行领域拆分 |
| 2 | King | 起草拆分方案 |
| 3 | 相关 Lord | Review 拆分方案 |
| 4 | 达成一致 | 进入圆桌会议 |
| 5 | 圆桌投票 | 各 Lord 投票 |
| 6 | 人类终审 | 系统管理员最终确认 |
| 7 | 生效 | 执行领域拆分，更新 Address Book |

### 6.2 领域合并

**触发条件**：King 发现领域 A 与领域 B 相关性很高，经常频繁跨域合作

| 阶段 | 执行者 | 描述 |
|:-----|:-------|:-----|
| 1 | King | 向两个领域提出合并建议 |
| 2 | King | 起草合并方案 |
| 3 | 领域 A/B Lord | Review 合并方案 |
| 4 | 达成一致 | 进入圆桌会议 |
| 5 | 圆桌投票 | 各 Lord 投票 |
| 6 | 人类终审 | 系统管理员最终确认 |
| 7 | 生效 | 执行领域合并，更新 Address Book |

### 6.3 Review 不合时的处理

1. **自动调解**：由 Chairperson 进行初步调解
2. **圆桌投票**：调解无效则上圆桌投票
3. **人类终审**：投票结果仍需人类确认

---

## 7. 关键业务流

### 7.1 系统创世 (System Genesis)

```
1. Admin 上传《公司业务白皮书》
2. King 分析文档，生成 Domain_Map_v1.json
3. Admin 在 Dashboard 审查并点击 Approve
4. System 初始化 Address Book，为每个领域创建 Lord Profile 和 RAG 索引
```

### 7.2 圆桌协同 (The Roundtable)

```
1. Sales Lord 发现 Q4 目标无法完成，发起动议
2. Chairperson 召集 Sales Lord 和 Tech Lord 入席圆桌
3. 对话:
   - Sales: "我们需要在双十一上线新落地页。"
   - Tech: "需要增加 2 个 Knight 资源用于开发。"
4. 信息熵检测通过，Chairperson 生成 Resolution
5. Tech Lord 领回任务，唤醒 Knight 开始写代码
6. 人类管理员确认配额申请
```

### 7.3 吹哨人机制 (Whistleblower)

```
1. Finance Lord 派遣 Knight 进行例行审计
2. Knight 发现异常资金流出
3. Finance Lord 评估严重性为 CRITICAL
4. Policy Engine 批准最高优先级打断
5. Notification Gateway 呼叫 CFO 手机，并发送 Slack 消息
6. CFO 点击链接，进入 "Finance Audit Session"，与 Agent 协同查账
```

### 7.4 领域拆分 (Domain Split)

```
1. Tech Lord 发现任务混杂了 Data Analysis 内容
2. Tech Lord 向 King 提议领域拆分
3. King 分析并起草拆分方案
4. Data Analysis Lord Review 方案
5. 达成一致，圆桌会议投票
6. 人类管理员批准
7. Address Book 更新，创建新的 Data Analysis Lord
```

---

## 8. 实施策略

### Phase 1: 基础建设 (The Foundation)

| 重点 | 里程碑 |
|:-----|:-------|
| K8s/Kata/JuiceFS 底座 | 基础设施就绪 |
| Knight 沙盒 | 安全执行环境完成 |
| 基础指令流 | King → Lord → Knight 单向路由 |

### Phase 2: 组织互联 (The Organization)

| 重点 | 里程碑 |
|:-----|:-------|
| Address Book | 统一通讯录上线 |
| Stateless Runtime | Hydration/Dehydration 机制完成 |
| Policy Engine | 主动报警功能上线 |
| Academy 基础架构 | 知识库、技能库、工具注册表基础框架 |

### Phase 2.5: 知识沉淀 (Knowledge Consolidation)

| 重点 | 里程碑 |
|:-----|:-------|
| 知识入库流程 | Lord 可提交知识，King 审核 |
| 知识检索 | 基于 RAG 的跨领域知识查询 |
| 技能共享 | 通用技能库支持多 Lord 复用 |

### Phase 3: 智慧涌现 (The Intelligence)

| 重点 | 里程碑 |
|:-----|:-------|
| Roundtable 机制 | 多 Lord 协同解决问题 |
| King 自动 DDD | 动态领域划分能力 |
| Moderator | 会议主持与死锁检测 |

---

## 9. 风险缓解

| 风险 | 缓解措施 |
|:-----|:---------|
| 领域碎片化 | King 定期评估，必要时主动发起合并 |
| 会议死锁 | 信息熵检测 + 限流 + 精简输出 |
| 权限越界 | GraphDB 边关系控制 + 跨域请求机制 |
| 资源争抢 | 配额制 + King 统一调度 |
| AI 骚扰 | Policy Engine 多维过滤 |
| 知识孤岛 | Academy 强制共享高价值知识 |
| 知识过时 | 版本管理 + 废弃标记机制 |
| 记忆丢失 | 记忆压缩 + VectorDB 持久化 + Git 归档 |

---

## 10. 总结

Silicon Realm 将 Cloud IDE 升级为 **Enterprise OS**：

### 核心架构：King + Canal

| 组件 | 隐喻 | 职责 |
|:-----|:-----|:-----|
| 👑 King | 决策中枢 | 思考、决策、规划、治理 |
| 🚢 Canal | 运河 | 容器编排、消息路由、资源调度、健康监控 |

**King + Canal = 最小可运行系统**。King 负责决策，Canal 负责让决策落地。

### 扩展架构：领域分化

| 角色 | 来源 | 职责 |
|:-----|:-----|:-----|
| 🏰 Lord | 从 King 拆分 | 专注特定业务领域 |
| ⚔️ Knight | 由 King/Lord 派发 | 执行原子任务 |

### 设计价值

| 特性 | 价值 |
|:-----|:-----|
| King + Canal | King (决策) + Canal (基础设施) 构成最小系统 |
| 身份即目录 | Agent 本质是配置化上下文，极低学习成本，绝对可审计 |
| 同构架构 | King 与 Lord 同构，Lord 是 King 的业务分身 |
| 双层会话 | 守护会话常驻响应 + Topic 会话任务隔离 |
| Knight 沙箱 | 安全隔离，用完即毁 |
| 圆桌会议 | 按需触发的协作机制，解决跨域协调问题 |
| 人类内阁 + 策略引擎 | 解决 AI 的安全与合规问题 |
| 学院 | 实现跨领域知识共享，避免重复造轮子 |
| 三层决策 | AI 自治→圆桌共识→人类终审，平衡效率与安全 |

---

## 版本历史

| 版本 | 变更内容 |
|:-----|:---------|
| v2.0 | 初始架构设计 |
| v2.1 | 添加领域演进机制、会议死锁防控、资源配额管理、决策流程优化 |
| v2.2 | 添加 Academy 跨领域知识共享 |
| v2.3 | 重命名为 Silicon Realm |
| v2.4 | MVP 优化：结构化圆桌流程、第一责任人原则、Spec 驱动执行、Git 版本控制 |
| v2.5 | 通信架构：King 常驻进程、inbox/outbox 机制、Lord 唤醒触发、Knight 任务生命周期 |
| v2.6 | 核心哲学升级：身份即目录、王室双星、文件系统作为真相源 |
| v2.7 | 记忆压缩机制：三层记忆、会话摘要、VectorDB 归档 |
| v2.8 | 双层会话模型：守护会话 + Topic 会话 |
| v2.9 | 同构架构：King 与 Lord 结构相同，Knight 重定义为沙箱 Subagent |
| v2.10 | 编排引擎详细架构设计 |
| v3.0 | 文档重构：优化结构、精简内容、提升可读性 |
| v3.1 | 目录结构：realm/ 改为 agents/，扁平化结构 |
| v3.2 | Queen 重命名为 Canal (运河)，强调基础设施定位而非角色 |
| v3.3 | 圆桌会议从"协同层"改为"协作机制"，强调其按需触发的仪式性质 |
